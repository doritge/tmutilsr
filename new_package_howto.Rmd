---
title: "R Package tutorial"
author: "Dorit Geifman"
date: "2019-01-13"
output:
  html_document:
    toc: yes
    toc_float: yes
  html_notebook: default
---

```{r, echo = FALSE}
knitr::opts_chunk$set(
  eval = FALSE
)
```

This tutorial  describes the steps for creating and maintaining a R package. It is based of the [R Packages](http://r-pkgs.had.co.nz/) book by Hadley Wickham. The tutorial assumes working with RStudio and using some of the tools it provides.

# New package

## Setup
The first step is to create a R package project in RStidio. This will create a package directory tree and templates for the requried files. Make sure that packages *devtools* and *roxigen2* are insalled. Next follow this workflow:

1. Update the meta-data in the DESCRIPTION file. Expect to update this file occasionaly
2. Write a package manual file *pkgname.R* that will be updated with each function you write
3. Start writing code in a script. The first save will save it to the **R** folder. The file should contain *roxigen* instructions
4. When happy Load package

**Notes:**

All files in this project will be processed into the bundle. If you want to exclude some files, such as temporary scripts you need to define them in the *.Rbuildignore* file. It is recommended not to do it manually but rather through a function call. More info [here](http://r-pkgs.had.co.nz/package.html#package).
```{r}
usethis::use_build_ignore("tmp")
```

## Package meta-data

[Package meta-data](http://r-pkgs.had.co.nz/description.html) is handled in the DESCRIPTION file. Some metadeta is updated manuallly and some should be done through a function inorder to maintain the file consistency

### Manual update

* Title
* Description
* Authors@R: c(person("Dorit", "Geifman", email = "dorit.geifman@gmail.com", role = c("aut", cre"))). Note that each package must have at least one aut role for citation and one cre role - the maintainer
* Version: 0.0.0.9000 - when starting development

### Dependencies
The packages to be installed when package is loaded are define by the Imports or Suggests or Depend tags. You should use the *use_package* function for defining dependencies as it handles ducplicate definitions and handles inconsistencies. Try to maintain an alphabetical loist. You should list basic package such *dplyr*, *ggplot* etc and not collections such as *tidyverse*.
```{r dependencies}
usethis::use_package("dplyr") # Imports is the default
usethis::use_package("readr", "Suggests")
```

## Package documentation
[Packaged documentation](http://r-pkgs.had.co.nz/man.html) is processed by the *roxygen2* package. This package  handles both the objects documentation and the namespace definitions. A comment line should start #' and should not extend 80n characters. This can be managed through Code->Reflow comment in RStudio. To generate documentation after changes use the RStudio Build->Documention menu or
```{r}
devtools::document()
```

### Introduction
The comments that are not tagged in the block of comments that preceed the function call and the distinct paragraphs are interpreted:

1. Function title
2. Function decsription
3. Details

Artbitrary sections can be added using the @section tag. Other predefined tags are detailed in the documentation.

### Functions
A block of function documentation mainly: @param, @examples and @return

## Namespaces
[Namespaces](http://r-pkgs.had.co.nz/namespace.html) defined in the NAMESPACE file but for consistency the file should be maintained as roxygen comments in the script file.

### Exports
Not all functions should be exported, some are internal to the package. Functions that the package exports should be preceede by the @export tag.

### Imports
If you don't want to preceed each function call with *pckname::* you should import the function either by importing the whole package by using the @import tag (not recommended), or by only importing the function using @importFrom tag. Note that it is recommended that seldomly used functions will not be imported but rather called explicitly in the script with the package name.
```{r}
#' @import dplyr

#' @importFrom dplyr group_by ungroup arrange filter row_number
#' @importFrom magrittr %>%
```

## Data
If you want to save data as part of you package you do this by calling use_data(). The parameter is the name of the dataset and this will also be the name of the file. The saved dataset is an .rda file and is significanly compressesed (4.6. MB of LDA object was compressed to 417KB on disk).
```{r data}
usethis::use_data(LDA_test)

data(LDA_test)  # Needs to be called only for explicit load of function
```
 
Note that to use the dataset, you need to reload the package after saving it. However any further use of the dataset is implicitly resolved, specifically in tests. It will be loaded only when needed. To explicitly load it, use the data() call.

The dataset should be documented in data.R. More details [here](http://r-pkgs.had.co.nz/data.html)

## Testing
The testing folders are not initiated with the project. As part of the package creation process use_testthat() should be called. It creates the relevant folders and the testthat.R file which is the master for running the tests.

All tests file names should start with "test" and reside in testthat directory. Details on how to create the test files can be found [here](http://r-pkgs.had.co.nz/tests.html)

Call test_package() to run all tests
```{r testing}
usethis::use_testthat()  # Initialing the testing mechanism

testthat::test_package("tmutilsr")
```

## Load, build, install

There are several modes to work with the package:

During the development process you should load it to memory using the RStudio Build->Load All menu or the devtool function
```{r}
devtools::load_all("../tmutilsr")
```
Note that you should always load pacakges that are not installed yet

You can generate a binary package that can be installed and then used as any other package. This is done by selecting the More->Build Binary Pacakge in the Build window of RStudio or alternatively user the devtools::build(binary = TRUE) function.

Note that when creating a binary for windows you must have Winzip and Rtools installed

